<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>おえかき</title>
  <style>
    #mycanvas{
      border: 10px solid #999;
    }
  </style>
</head>
<body>
  <p>
    <select id="penType">
      <option value="0">フリー</option>
      <option value="1">直線</option>
    </select>
    <select id="penColor">
      <option value="black">黒</option>
      <option value="red">赤</option>
      <option value="blue">青</option>
      <option value="white">白</option>
    </select>
    <select id="penWidth">
      <option value="1">細</option>
      <option value="3">中</option>
      <option value="5">太</option>
    </select>
    <input type="button" id="erase" value="消去">
  </p>
  <canvas width="400" height="200" id="mycanvas">
    Canvasに対応したブラウザを用意してください。
  </canvas>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script>
    //直線用
    var oldX = null;
    var oldY = null;
    var moveX = null;
    var moveY = null;
    var pX = null;
    var pY = null;
    var storedLines = [];

    var canvas = document.getElementById('mycanvas');
    var ctx = canvas.getContext('2d');

    //直線描画処理用
    function Redraw(){
      //ctx.clearRect(0,0,canvas.width,canvas.height);
      if(storedLines.length == 0){
        return;
      }
      for(var i = 0; i<storedLines.length; i++){
        ctx.beginPath();
        ctx.moveTo(storedLines[i].x1, storedLines[i].y1);
        ctx.lineTo(storedLines[i].x2, storedLines[i].y2);
        ctx.stroke();
      }
    }

    var penType = 0;
    $(function(){
        if(!canvas || !canvas.getContext)
        {
          return false;
        }

        var startX,
            startY,
            x,
            y,
            borderWidth = 10,
            isDrawing = false;

        $('#mycanvas').mousedown(function(e){
          isDrawing = true;

          if(penType == 1)
          {
            startX = e.offsetX;
            startY = e.offsetY;            
          }
          else
          {
            startX = e.pageX - $(this).offset().left - borderWidth;
            startY = e.pageY - $(this).offset().top - borderWidth;
          }
        })
        .mousemove(function(e){
          if(!isDrawing){
            return;
          }

          if(penType == 1)
          {
            Redraw();
            x = e.offsetX;
            y = e.offsetY;
            ctx.lineJoin = "round";
            ctx.lineCap = "round";
            ctx.beginPath();
            ctx.moveTo(startX,startY);
            ctx.lineTo(x,y);
            ctx.stroke();
          }
          else
          {
            x = e.pageX - $(this).offset().left - borderWidth;
            y = e.pageY - $(this).offset().top - borderWidth;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(x, y);
            ctx.stroke();
            startX = x;
            startY = y;
          }
        })
        .mouseup(function(e){
          isDrawing = false;
          if (penType == 1) {
            pX = e.offsetX;
            pY = e.offsetY;
            storedLines.push({
              x1: startX,
              y1: startY,
              x2: pX,
              y2: pY
            })
          }
        })
        .mouseleave(function(){
          isDrawing = false;
        });

        $('#penType').change(function(){
          penType = $(this).val();
        });

        $('#penColor').change(function(){
          ctx.strokeStyle = $(this).val();
        });

        $('#penWidth').change(function(){
          ctx.lineWidth = $(this).val();
        });

        $('#erase').click(function(){
          if(!confirm('本当に消去しますか？')) return;
          ctx.clearRect(0,0,canvas.width,canvas.height);
        });
    });
  </script>
</body>
</html>
